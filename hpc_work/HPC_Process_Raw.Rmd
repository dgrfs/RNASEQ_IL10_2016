---
title: "Untitled"
author: "D Griffiths"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Process raw sequencing files

## Get data

Data is stored on the RDS under 'raw data'

Transfer to the HPC for processing

Inflate the compressed files (and can run the md5 checksum to ensure that the transfer was successful)

Then move on to processing using nextflow. A tutorial can be found here:

https://github.com/dgrfs/NFCore_RNASeq_Cardiff_University_Hawk


``` sh
# lang: sh

tar -xvf 161006_Run35_fastq.tar.gz
```

``` r
# lang: R

library(tidyverse)

# List the files in the directory
files <- list.files(pattern = ".fastq.gz")

# Split the filenames by underscores
split_files <- str_split(files, "_")

# Extract sample, seq, read, and lane information from the split filenames
info <- data.frame(
  sample = sapply(split_files, `[`, 1),
  seq = sapply(split_files, `[`, 2),
  read = ifelse(grepl("R1", files), "R1", "R2"),
  lane = sapply(split_files, `[`, 4)
)

# Create the output data frame
output_df <- data.frame(
  sample = info$sample,
  fastq_1 = files,
  fastq_2 = gsub("_R1_", "_R2_", files),
  strandedness = "auto",
  seq.run = "H7YRLADXX",
  lane = paste0("L", info$lane)
)      

output_df <- output_df %>%
  mutate(lane = str_remove(lane, "\\.fastq\\.gz$"))     

 # Write the output data frame to a CSV file
 write.csv(output_df, "samplesheet.csv", row.names = FALSE)     
```

``` sh
# lang: sh

mkdir ref
cd ref

cat << 'EOF' > get-refs.sh
 #!/bin/bash
 VERSION=108
 wget -L ftp://ftp.ensembl.org/pub/release-$VERSION/fasta/homo_sapiens/dna/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa.gz
 wget -L ftp://ftp.ensembl.org/pub/release-$VERSION/gtf/homo_sapiens/Homo_sapiens.GRCh38.$VERSION.gtf.gz
EOF

bash get-refs.sh

# back to working directory
cd ..

# get config
wget https://raw.githubusercontent.com/dgrfs/NFCore_RNASeq_Cardiff_University_Hawk/main/adapted.scw.config

# get params
wget https://raw.githubusercontent.com/dgrfs/NFCore_RNASeq_Cardiff_University_Hawk/main/params.yaml

# set up screen/tmux to run in background
module load tmux
tmux

# load dependencies
module load singularity-ce/3.11.4
module load nextflow/22.10.6

nextflow run nf-core/rnaseq \
    -r 3.12.0 \
    -params-file params.yaml \
    -profile singularity \
    -c adapted.scw.config \
    --fasta $PWD/ref/Homo_sapiens.GRCh38.dna_sm.primary_assembly.fa.gz \
    --gtf $PWD/ref/Homo_sapiens.GRCh38.108.gtf.gz 
```

