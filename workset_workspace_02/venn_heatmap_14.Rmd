---
title: "Heatmap DE genes in IL21"
author: "Dan Griffiths"
date: "2023-11-28"
output:
  html_document: default
---

### Load libraries
```{r libraries, message = FALSE}
library(limma)
library(Glimma)
library(tidyverse)
library(DESeq2)
library(org.Hs.eg.db)
library(pheatmap)
library(EnhancedVolcano)
library(ComplexHeatmap)
library(gplots)
library(msigdbr)
library(clusterProfiler)
library(enrichplot)
library(DOSE)
```

### Import data
```{r}
counts <- read_rds(file = "counts_matrix_raw.rds")
coldata <- read_rds(file = "coldata_dataframe.rds")
identical(colnames(counts), coldata$sample)
```


### Rename gene names 
```{r, message=FALSE}
gene.list <- data.frame(entrez.id = rownames(counts))
gene.list <- gene.list %>%
  dplyr::mutate(
    SYMBOL = mapIds(org.Hs.eg.db, keys = gene.list$entrez.id, column = "SYMBOL", keytype = "ENTREZID"),
    GENETYPE = mapIds(org.Hs.eg.db, keys = gene.list$entrez.id, column = "GENETYPE", keytype = "ENTREZID"),
    ENSEMBL = mapIds(org.Hs.eg.db, keys = gene.list$entrez.id, column = "ENSEMBL", keytype = "ENTREZID")
  )

# Rename to SYMBOL
filtered.gene.list <- gene.list %>%
  dplyr::filter(
    !is.na(ENSEMBL),
    !duplicated(ENSEMBL),
    # GENETYPE == "protein-coding"
  )

# Rename gene IDs from ensembl to symbol
counts <- counts[rownames(counts) %in% filtered.gene.list$entrez.id, ]
rownames(counts) <- filtered.gene.list$SYMBOL[match(rownames(counts), filtered.gene.list$entrez.id)]

```

### Generate DESeq2 object
IL7 removed from analysis completely.
```{r, message=FALSE, warning=FALSE}
dds <- DESeqDataSetFromMatrix(counts,coldata, design = ~healthy_donor + condition)
dds <- estimateSizeFactors(dds)
idx <- rowSums(counts(dds, normalized=TRUE) >= 5 ) >= 3
dds <- dds[idx,]
dds <- DESeq(dds)
vst <- varianceStabilizingTransformation(dds)
vsn::meanSdPlot(assay(vst))
plotPCA(vst)
```



### Total variance heatmap
```{r,fig.height=10,fig.width=10}
vst_data <- assay(vst)
topVarGenes <- order(rowVars(vst_data), decreasing = TRUE)
mat  <- vst_data[topVarGenes[1:20], ]
mat  <- mat - rowMeans(mat)

anno <- as.data.frame(colData(dds))
annocols1 <- paste(c(unique(anno$condition)))
annocols2 <- paste(c(unique(anno$healthy_donor)))
vip.cols1 <- RColorBrewer::brewer.pal(name = "Dark2", n = length(annocols1))
vip.cols2 <- RColorBrewer::brewer.pal(name = "Set2", n = length(annocols2))
names(vip.cols1) = sort(unique(anno$condition))
names(vip.cols2) = sort(unique(anno$healthy_donor))

HA <- columnAnnotation(df = anno %>% dplyr::select(c("condition","healthy_donor")), col = list(condition=vip.cols1,healthy_donor=vip.cols2))

Heatmap(mat, 
        name = "Relative variance",
        column_title = "Filtered counts matrix \n Variance stabilised expression heatmap \n Gene expression relative to the mean", 
        top_annotation = HA, 
        cluster_columns = FALSE, 
        column_split = anno$healthy_donor,
        cluster_rows = TRUE
        )

```














### DESeq2 results pairwise each condition
```{r}
res.il15 <- results(dds,contrast = c("condition","IL21","IL15"))
res.sig.il15 <- subset(res.il15, padj < 0.1)
lfc.il15 <- res.sig.il15[ order(res.sig.il15$log2FoldChange, decreasing=TRUE), ]
summary(lfc.il15)
lfc.il15
res.il2 <- results(dds,contrast = c("condition","IL21","IL2"))
res.sig.il2 <- subset(res.il2, padj < 0.1)
lfc.il2 <- res.sig.il2[ order(res.sig.il2$log2FoldChange, decreasing=TRUE), ]
summary(lfc.il2)
lfc.il2

lfc.il15.df <- lfc.il15 %>% as.data.frame() %>% rownames_to_column(.,var = 'GENE_ID')
lfc.il2.df <- lfc.il2 %>% as.data.frame() %>% rownames_to_column(.,var = 'GENE_ID')
write_csv(lfc.il15.df, "lfc_il15_results.csv")
write_csv(lfc.il2.df, "lfc_il2_results.csv")
```




```{r}
# reading in data from deseq2
# df = read.csv("~/Downloads/drosphila_example_de.csv", header=TRUE)
df <- res.il2
df <- data.frame(df)

# we want the log2 fold change 
original_gene_list <- df %>% rownames_to_column() %>% dplyr::select(c("rowname","log2FoldChange"))

# name the vector
names(original_gene_list) <- df$X

# omit any NA values 
gene_list<-na.omit(original_gene_list)

geneList = df %>% dplyr::select("log2FoldChange")
gene_list_ordered <- gene_list[order(gene_list[,2], decreasing = TRUE), ]
rownames(gene_list_ordered) <- gene_list_ordered[,1]
gene_list_ordered <- gene_list_ordered[,2]
names(gene_list_ordered) <- rownames(df)
```




```{r}
gse <- gseGO(geneList=gene_list_ordered,
             ont ="BP", 
             keyType = "SYMBOL", 
             minGSSize = 3, 
             maxGSSize = 800, 
             pvalueCutoff = 0.05, 
             verbose = TRUE, 
             OrgDb = org.Hs.eg.db,
             pAdjustMethod = "none")
```

```{r,fig.height=15}
dotplot(gse, showCategory=20
        , split=".sign") + 
  facet_grid(.~.sign)

goplot(gse)
ridgeplot(gse) + labs(x = "enrichment distribution")
# Use the `Gene Set` param for the index in the title, and as the value for geneSetId
gseaplot(gse, by = "all", title = gse$Description[1], geneSetID = 1)

x2 = pairwise_termsim(gse)
emapplot(x2, showCategory = 20)

```

```{r}
retrieved <- AnnotationDbi::select(org.Hs.eg.db, keytype="GOALL", keys="GO:0045321", columns="SYMBOL")
head(retrieved)
```




```{r}
original_gene_list = res.il15$log2FoldChange

# name the vector
names(original_gene_list) <- res.il15$GeneSymbol

# omit any NA values 
gene_list<-na.omit(original_gene_list)
ids = bitr(names(original_gene_list), fromType = "SYMBOL", toType = "ENTREZID", OrgDb = org.Hs.eg.db)

# remove duplicate IDS (here we use "SYMBOL", but it should be whatever was selected as keyType)
dedup_ids = ids[!duplicated(ids[c("SYMBOL")]),]
dedup_ids <- as.data.frame(dedup_ids)

# Create a new dataframe df2 which has the respective entrez IDs for the gene symbols.
colnames(dedup_ids) = c("GeneSymbol", "EntrezID")
res.il15$GeneSymbol <- rownames(res.il15)
df2 = merge(as.data.frame(res.il15), dedup_ids, by = "GeneSymbol")
head(df2)

# Create a vector of the gene universe
kegg_gene_list = df2$log2FoldChange

# Name vector with ENTREZ ids
names(kegg_gene_list) = df2$EntrezID

# omit any NA values 
kegg_gene_list = na.omit(kegg_gene_list)

# sort the list in decreasing order (required for clusterProfiler)
kegg_gene_list = sort(kegg_gene_list, decreasing = TRUE)

kegg_organism = "hsa"
kk2 = gseKEGG(geneList     = kegg_gene_list,
               organism     = kegg_organism,
               minGSSize    = 3,
               maxGSSize    = 800,
               pvalueCutoff = 0.05,
               pAdjustMethod = "none",
               keyType       = "ncbi-geneid")

```


```{r}
dotplot(kk2, showCategory = 10, title = "Enriched Pathways" , split=".sign") + facet_grid(.~.sign)

```

```{r}
out = as.matrix(kk2@result)
out = out[, 1:10]
head(out, 40)
```


```{r}
#Geneset plot

# Use the `Gene Set` param for the index in the title, and as the value for geneSetId
gseaplot(kk2, by = "all", title = kk2$Description[36], geneSetID = 36)
```


### Venn diagram common genes that are immunologically relevent (msigDB C7 genesets)
To extract a list of interesting genes which is DE in both conditions

```{r}
## Data preparation
il15.degs <- row.names(lfc.il15)
il2.degs <- row.names(lfc.il2)
list.degs <- unique(paste(c(il15.degs,il2.degs)))

# Create a Venn-diagram given just the list of gene-names for both sets
venn(list("IL15vsIL21" = il15.degs, "IL2vsIL21" = il2.degs), )
common_genes <- Reduce(intersect, list(il2.degs, il15.degs))

db.gs.c7 <- msigdbr(species = "human", category = "C7", subcategory = "IMMUNESIGDB")
c7.common.genes <- common_genes[common_genes %in% unique(db.gs.c7$gene_symbol)]

venn(list("IL15vsIL21" = il15.degs, "IL2vsIL21" = il2.degs, "c7genes" = c7.common.genes), )

DT::datatable(as.data.frame(c7.common.genes))

## check the 12 genes

## cd markers and secreted proteins !!!!

# extract 566 geens into raw matrix

# over analysis
# re-analysis from previous infromation
# this wont change the problem with DE as shown in the heatmap

# expression level and LFC

# function annotations 

# 500 heatmap
# UP GENES Heatmap



```


```{r}
# test <- gse@result %>% dplyr::filter(ID %in% "GO:0007154")
BiocManager::install("ViSEAGO")

```

### Volcano plot
```{r,fig.height=10,fig.width=15}
EnhancedVolcano(res.il2,
    lab = rownames(res.il2),
    x = 'log2FoldChange',
    y = 'padj',
    title = 'IL21 versus IL2',
    pCutoff = 5e-2,
    FCcutoff = 1.5,
    pointSize = 3.0,
    labSize = 6.0)

EnhancedVolcano(res.il15,
    lab = rownames(res.il15),
    x = 'log2FoldChange',
    y = 'padj',
    title = 'IL21 versus IL15',
    pCutoff = 5e-2,
    FCcutoff = 1.5,
    pointSize = 3.0,
    labSize = 6.0)

# change to p adjust

```

- label cytokines
- focus on UP genes
log heatmap
select for function genes and display
the big 560


```{r}
# Load libraries
library(DOSE)
library(pathview)
library(clusterProfiler)
```


```{r}
## Merge the AnnotationHub dataframe with the results 
res_ids <- inner_join(as.data.frame(res.il15), annotations_ahb, by=c("gene"="gene_id"))    
```




## R session info

```{r}
sessionInfo()
```
